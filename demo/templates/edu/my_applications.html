{% extends 'userena/base_userena.html' %}
{% load i18n %}
{% load url from future %}
{% block title %}{% trans "My Applications" %}{% endblock %}
{% block extra_js %}
<script type="text/javascript">
  /*<![CDATA[*/
             
 $(document).ajaxSend(function(event, xhr, settings) {
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function sameOrigin(url) {
        // url could be relative or scheme relative or absolute
        var host = document.location.host; // host + port
        var protocol = document.location.protocol;
        var sr_origin = '//' + host;
        var origin = protocol + sr_origin;
        // Allow absolute or scheme relative URLs to same origin
        return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
            (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
            // or any other URL that isn't scheme relative or absolute i.e relative.
            !(/^(\/\/|http:|https:).*/.test(url));
    }
    function safeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
    }
});
  
  
  $(document).ready(function() {
        $('#searchform').submit(function() {// catch the form's submit event
        	$('#appmessages').html("Searching...")
            $.ajax({ // create an AJAX call...
                data: $(this).serialize(), // get the form data
                type: $(this).attr('method'), // GET or POST
                url: $(this).attr('action'), // the file to call
                success: function(response) { // on success..
                	$('#searchresults').html(response);
                	$('#appmessages').html("");
                }
            });
            return false;
        });
    });
  	function js_show_streams(inst_pk){
  		$.get("{% url 'edu_get_streams_for_institute' %}", {inst_pk: inst_pk}, function(response){
  			$('#allstreamswrapper-' + inst_pk).html(response);
  		})
  	}
  	function js_apply_streams(inst_pk, div_id){
		var selected_streams = [];
	    // get all checked items
	    var checked = $("#" + div_id).find('input:checked');
	    // for each of them
	    $.each(checked, function() {
	    	selected_streams.push($(this).attr('name'));
	    });

		$.ajax({ // create an AJAX call...
            data: {inst_pk : inst_pk, selected_streams : selected_streams.join(",")}, // get the form data
            type: 'POST', // GET or POST
            url: "{% url 'edu_apply_for_institute' %}", // the file to call
            success: function(response) { 
            	alert(response);// on success..
            	$.easyNotification('Success! Your application has been received.'); 
            	$('#appmessages').html("Success! Your application has been received.");
            }
        });
  	}
  	function js_delete_application(appln_id){
		$.ajax({ // create an AJAX call...
            data: {appln_id : appln_id}, // get the form data
            type: 'POST', // GET or POST
            url: "{% url 'edu_delete_application' %}", // the file to call
            success: function(response) { 
            	//alert(response);// on success..
            	btnid = 'deleteapplication-' + appln_id;
            	delete_row(btnid);
            	$.easyNotification('Success! Your application has been deleted'); 
            	//$('#appmessages').html("Success! Your application has been deleted");
            }
        });
  	}
  	function delete_row(btnid){    
        if (btnid != "") {         
             $('#'+btnid).closest("tr").remove();
          } 
  	};
  /*]]>*/
</script>
{% endblock %}

{% block content_title %}<h2 class="content-title">Applications &raquo; {{ account.user.username }}</h2>{% endblock %}

{% block content %}
  <ul id="profile-nav">
      <!-- <li><a href="#">{% trans "View profile" %}</a></li>  -->
      <li><a href="{% url 'edu_index' %}">{% trans "Search and Apply" %}</a></li>
      <li class="selected"><a href="{% url 'edu_my_applications' %}">{% trans "My Applications" %}</a></li>
      <!-- <li><a href="#">{% trans "Change email" %}</a></li> -->
  </ul>
  <div id="appmessages"></div>
  <table id='my-applications'>
  	<thead>
  		<th>Application ID</th>
  		<th>Institute</th>
  		<th>Stream</th>
  		<th>Priority</th>
  		<th>Created on</th>
  		<th>Actions</th>
  	</thead>
  	<tbody>
  	{% for application in applications %}
  		<tr>
  			<td>{{ application.appln_id }}</td>
  			<td>{{ application.institute.name }}</td>
  			<td>{{ application.stream.name }}</td>
  			<td>{{ application.priority_number }}</td>
  			<td>{{ application.created_date }}</td>
  			<td><input type='button' class='button' value='Delete' id='deleteapplication-{{ application.appln_id }}'
  			 onclick="js_delete_application('{{ application.appln_id }}')"></td>
  		</tr>
  	{% endfor %}
  	</tbody>
  </table>
{% endblock %}